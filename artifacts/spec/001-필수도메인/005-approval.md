## 결재(Approval) 도메인 모델

## 모델링 바이브

- Approval 바이브
    - 엄격한 절차 (Sequential Process): 기안부터 최종 승인까지 정해진 순서와 규칙을 반드시 따라야 합니다.
    - 불변 기록 (Immutable Record): 결재가 완료된 문서는 수정할 수 없으며, 누가 언제 승인/반려했는지 영구히 보존되어야 합니다.
    - 동적 선로 (Dynamic Routing): 전결 규정에 따라 결재선이 부서장, 본부장 등으로 자동 생성되어야 하는 '똑똑함'이 필요합니다.
- 유비쿼터스 언어 점검
    - Drafter (기안자): 문서를 처음 작성하여 결재를 올린 사람.
    - Approver (승인자): 문서에 대해 찬성/반대 의사를 결정할 권한을 가진 사람.
    - Arbitrary Decision (전결): 상급자의 권한을 위임받아 하급자가 최종 결정하는 행위.
    - Proxy Approval (대결): 승인자 부재 시 미리 지정된 대리인이 대신 결재하는 행위.
    - Reject (반려): 결재를 거부하고 기안자에게 서류를 되돌려 보냄.
- 도메인간 상호 작용
    
    결재 도메인은 다른 도메인들과 다음과 같이 대화합니다.
    
    1. User 도메인: 결재선의 자동 생성을 위해 사용자의 조직도(부서, 직급)를 참조합니다.
    2. Menu/Permission 도메인: "결재가 최종 완료되어야만" 특정 메뉴에 대한 `Role`을 유저에게 실제로 부여하는 프로비저닝(Provisioning) 액티비티가 실행됩니다.
    3. Audit Log: 결재의 모든 단계(기안, 승인, 반려)는 그 자체로 중요한 감사 대상이므로 상세히 박제됩니다.
    4. 근무조(Shift) 도메인: 근무조 스케줄에 따라 '야간 근무 수당 신청' 같은 결재 양식의 데이터 정합성을 검증합니다.
- 액티비트 흐름 요약
    
    설계(Q, R, S) -> 실행(N, O, P) -> 상태 전이(이벤트)
    
    | 구분 | ID | 액티비티 명 | 핵심 내용 |
    | --- | --- | --- | --- |
    | 운영 | Q | 결재 양식 설계 | 입력 필드 및 자동 결재선 규칙(전결/합의) 정의 |
    | 운영 | R | 양식 버전 관리 | 프로세스 변경 시 하위 호환성 유지 및 버전 교체 |
    | 운영 | S | 양식 접근 제어 | Role/부서별 기안 권한 할당 |
    | 실행 | N | 결재 기안 | 양식에 맞춰 내용 작성 및 결재선 자동 생성 |
    | 실행 | O | 검토 및 승인 | 단계별 승인권자의 승인/반려/의견 작성 |
    | 실행 | P | 전결 및 합의 | 상급자 대행(전결) 또는 관련 부서 협조(합의) 처리 |

---

## Model

결재 도메인은 크게 '결재 양식', '결재 문서', 그리고 그 안의 '결재선'으로 나뉩니다.

### A. Approval Template (결재 양식)

- `templateId`: PK
- `title`: 휴가 신청서, 비품 구매 요청, 권한 부여 요청 등
- `formSchema`: 결재 시 입력받을 항목 정의 (JSON 형식)
- `defaultRouteId`: 이 양식이 기본으로 사용하는 결재선 정의 ID
- `version`: 양식 버전 번호
- `isActive`: 현재 사용 가능 여부
- `allowedRoles`: 기안 가능한 Role 목록 (FK list)
- `autoRouteRules`: 결재선 자동 생성을 위한 조건부 로직 (예: `if amount > 1,000,000 then add role:CFO`)

### B. Approval Document (결재 문서)

- `documentId`: PK
- `templateId`: FK (어떤 양식인가)
- `drafterId`: FK (기안자 - User)
- `title`: 문서 제목
- `content`: 기안 내용 (JSON 또는 마크업)
- `status`: `DRAFT`(임시저장), `IN_PROGRESS`(결재중), `APPROVED`(완료), `REJECTED`(반려), `CANCELED`(회수)

### C. Approval Line (결재선/결재자)

- `lineId`: PK
- `documentId`: FK
- `approverId`: FK (승인권자 - User)
- `stepOrder`: 결재 순서 (1: 검토, 2: 승인, 3: 합의 등)
- `lineType`: `APPROVER`(승인), `CONSULTANT`(합의), `RECIPIENT`(참조)
- `status`: `PENDING`(대기), `CURRENT`(현재순서), `COMPLETED`(완료), `REJECTED`(반려)
- `comment`: 승인/반려 의견
- `processedAt`: 처리 일시

### 결재선 상태 변화 흐름도

| 현재 상태 (Status) | 전이 이벤트 (Event) | 결과 상태 (Target) | 비고 |
| --- | --- | --- | --- |
| (None) | 기안(Draft) 발행 | PENDING | 아직 내 차례가 오지 않은 대기 상태 |
| PENDING | 이전 단계 승인 완료 | CURRENT | 현재 내가 결재해야 할 차례 (알림 발송) |
| CURRENT | 승인 버튼 클릭 | COMPLETED | 승인 완료, 다음 순서로 바톤 터치 |
| CURRENT | 반려 버튼 클릭 | REJECTED | 결재 프로세스 즉시 중단 및 기안자 회송 |
| PENDING/CURRENT | 기안자 회수(Cancel) | CANCELED | 기안자가 문서를 거두어들임 |

- 특수 시나리오 (전결 및 대결)
    - 전결(Arbitrary Decision) 발생 시:
        - 현재 결재자가 승인하면, 뒤에 남은 모든 `PENDING` 결재자들의 상태를 즉시 `SKIPPED` 또는 `COMPLETED`로 변경하고 문서를 최종 승인 처리합니다.
    - 대결(Proxy) 발생 시:
        - `approverId`는 원래 승인자이지만, 실제 행위자(`actorId`)는 대리인임을 `Audit Log`와 결재선 모델의 `processedBy` 필드에 명시합니다.
- 도메인 통합 관점에서의 상태 관리
    - 인가 체크: `Activity G(맥락 검증)`에서 "이 문서의 현재 결재선 상에 당신이 `CURRENT` 상태인가?"를 확인하여 승인 버튼 활성화 여부를 결정합니다.
    - 보안 강화: `isHighPrivilege`가 걸린 결재 문서가 `COMPLETED`로 변하는 순간, `Audit Log` 도메인은 이를 '중요 보안 이벤트'로 분류하여 별도 관리합니다.

---

## Activity

## 결재 실행

### N. 결재 기안 (Drafting)

- 행위: 사용자가 양식을 선택하고 내용을 작성하여 결재를 올립니다.
- 로직: 기안자의 부서 정보(`departmentId`)와 직급(`position`)을 바탕으로 전결 규정에 따른 결재선을 자동 생성합니다.

### O. 검토 및 승인 (Review & Approve)

- 행위: 자신의 순서가 된 승인권자가 문서를 확인하고 승인 또는 반려를 결정합니다.
- 보안: 민감한 결재(예: 권한 상향)의 경우, 승인 버튼 클릭 시 `is2faRequired`가 작동하여 추가 인증을 요구합니다.

### P. 전결 및 합의 (Special Approval)

- 행위: 특정 금액 미만일 경우 하위 직급에서 종결(전결)하거나, 타 부서의 동의(합의)를 받는 과정입니다.
- 직무 분리(SoD): 기안자와 승인자가 동일인일 경우 승인을 차단하는 로직이 여기서 실행됩니다.

## 결재 양식

### Q. 결재 양식 설계 (Template Design)

- 행위: 관리자가 새로운 결재 프로세스를 정의하기 위해 양식을 생성합니다.
- 로직: 입력 항목 정의: `formSchema`를 통해 기안자가 입력해야 할 필드(텍스트, 날짜, 금액, 첨부파일 등)를 구성합니다.
    - 전결/합의 규칙 설정: 특정 금액 이상일 경우 반드시 본부장 승인을 거쳐야 하는 등의 자동 결재선 생성 규칙을 임베딩합니다.
- Vibe: "휴가 신청서"와 "비품 구매 요청서"는 입력받는 데이터도, 거쳐야 하는 사람도 다르다는 점을 여기서 설계합니다.

### R. 결재 양식 버전 관리 (Template Versioning)

- 행위: 운영 중 양식 내용이나 결재 규칙이 변경될 때 기존 문서에 영향을 주지 않고 업데이트합니다.
- 로직: 기존 양식을 `Archived` 처리하고 새 버전을 `Active`로 전환합니다. 이미 결재 진행 중인 문서는 이전 버전을 따르도록 보장합니다.

### S. 양식별 권한 제어 (Template Access Control)

- 행위: 특정 부서나 Role을 가진 사람만 특정 양식을 기안할 수 있도록 제한합니다. (예: '법인카드 신청'은 정직원 Role만 가능)
- 연동: 우리가 설계한 Menu/Permission 도메인과 연동되어, 사용자가 기안 가능한 양식 목록을 필터링하는 데 사용됩니다.

---